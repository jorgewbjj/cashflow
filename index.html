<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Fluxo de Caixa - 24 Meses</title>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f7fa;
      margin: 0;
      padding: 20px;
    }
    h2 {
      text-align: center;
      color: #333;
    }
    .table-container {
      overflow-x: auto;
      margin-top: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 8px;
      border: 1px solid #ccc;
      text-align: center;
      min-width: 100px;
    }
    th:first-child, td:first-child {
      position: sticky;
      left: 0;
      background: #f0f0f0;
      z-index: 1;
    }
    td[contenteditable] {
      background-color: #fff;
      cursor: pointer;
    }
    tfoot {
      background: #eef4ff;
      font-weight: bold;
    }
    #addCategoryBtn {
      background: none;
      border: 1px solid #007BFF;
      color: #007BFF;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      margin: 10px 0;
    }
    #addCategoryBtn:hover {
      background: #007BFF;
      color: #fff;
    }
    .edit-controls {
      font-size: 12px;
      color: #007BFF;
      cursor: pointer;
      margin-left: 5px;
    }
    canvas {
      margin-top: 30px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>

<h2>Fluxo de Caixa - 24 Meses</h2>
<button id="addCategoryBtn">+ Adicionar Categoria</button>

<div class="table-container">
  <table id="cashFlowTable">
    <thead>
      <tr>
        <th>Categoria</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr id="monthlyTotalRow"><td>Saldo do M√™s</td></tr>
      <tr id="accumulatedTotalRow"><td>Saldo Acumulado</td></tr>
    </tfoot>
  </table>
</div>

<canvas id="chart" height="100"></canvas>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyC8w5g9ot_LWkFgpsZN0UBDOeREeSd17UA",
  authDomain: "cashflow-6188e.firebaseapp.com",
  databaseURL: "https://cashflow-6188e-default-rtdb.firebaseio.com",
  projectId: "cashflow-6188e",
  storageBucket: "cashflow-6188e.firebasestorage.app",
  messagingSenderId: "644882577807",
  appId: "1:644882577807:web:92e5e6df27c4d0d7feb3fa"
};
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const meses = Array.from({ length: 24 }, (_, i) => {
    const d = new Date();
    d.setMonth(d.getMonth() + i);
    return d.toLocaleString('pt-BR', { month: 'short', year: '2-digit' });
  });

  const table = document.getElementById("cashFlowTable");
  const theadRow = table.querySelector("thead tr");
  const tbody = table.querySelector("tbody");
  const totalRow = document.getElementById("monthlyTotalRow");
  const acumuladoRow = document.getElementById("accumulatedTotalRow");

  let categorias = [];

  meses.forEach(m => {
    theadRow.innerHTML += `<th>${m}</th>`;
    totalRow.innerHTML += `<td>0</td>`;
    acumuladoRow.innerHTML += `<td>0</td>`;
  });

  document.getElementById("addCategoryBtn").onclick = () => {
    const nome = prompt("Nome da categoria:");
    if (!nome) return;
    const tipo = prompt("Tipo: receita ou despesa?").toLowerCase();
    if (!["receita", "despesa"].includes(tipo)) return alert("Tipo inv√°lido.");
    const nova = { nome, tipo };
    categorias.push(nova);
    salvarCategorias();
    desenharLinhaCategoria(nova);
  };

  function desenharLinhaCategoria(cat, valores = []) {
    const tr = document.createElement("tr");
    const tdLabel = document.createElement("td");
    tdLabel.innerHTML = `${cat.nome} (${cat.tipo}) <span class="edit-controls" onclick="editarCategoria('${cat.nome}')">‚úèÔ∏è</span> <span class="edit-controls" onclick="removerCategoria('${cat.nome}')">üóëÔ∏è</span>`;
    tr.appendChild(tdLabel);

    for (let i = 0; i < 24; i++) {
      const td = document.createElement("td");
      td.contentEditable = true;
      td.textContent = valores[i] || "";
      td.addEventListener("input", () => {
        salvarValores();
        calcularTotais();
      });
      tr.appendChild(td);
    }
    tr.dataset.nome = cat.nome;
    tr.dataset.tipo = cat.tipo;
    tbody.appendChild(tr);
  }

  function calcularTotais() {
    const totais = Array(24).fill(0);
    const acumulados = Array(24).fill(0);

    tbody.querySelectorAll("tr").forEach(tr => {
      const tipo = tr.dataset.tipo;
      [...tr.cells].slice(1).forEach((td, idx) => {
        const val = parseFloat(td.textContent.replace(",", ".")) || 0;
        totais[idx] += tipo === "despesa" ? -val : val;
      });
    });

    totais.forEach((v, i) => {
      totalRow.cells[i + 1].textContent = v.toFixed(2);
      acumulados[i] = (acumulados[i - 1] || 0) + v;
      acumuladoRow.cells[i + 1].textContent = acumulados[i].toFixed(2);
    });

    atualizarGrafico(acumulados);
  }

  function salvarCategorias() {
    db.ref("categorias").set(categorias);
  }

  function salvarValores() {
    const dados = {};
    tbody.querySelectorAll("tr").forEach(tr => {
      const nome = tr.dataset.nome;
      const valores = [...tr.cells].slice(1).map(td => td.textContent);
      dados[nome] = valores;
    });
    db.ref("valores").set(dados);
  }

  function editarCategoria(nome) {
    const nova = prompt("Novo nome da categoria:", nome);
    if (!nova) return;
    categorias = categorias.map(c => c.nome === nome ? { ...c, nome: nova } : c);
    salvarCategorias();
    location.reload();
  }

  function removerCategoria(nome) {
    if (!confirm("Remover categoria?")) return;
    categorias = categorias.filter(c => c.nome !== nome);
    salvarCategorias();
    db.ref("valores/" + nome).remove();
    location.reload();
  }

  // Carregar do Firebase
  db.ref("categorias").once("value", snap => {
    if (snap.exists()) {
      categorias = snap.val();
      db.ref("valores").once("value", valSnap => {
        categorias.forEach(cat => {
          const valores = valSnap.child(cat.nome).val() || [];
          desenharLinhaCategoria(cat, valores);
        });
        calcularTotais();
      });
    }
  });

  // Gr√°fico
  const ctx = document.getElementById('chart').getContext('2d');
  const grafico = new Chart(ctx, {
    type: 'line',
    data: {
      labels: meses,
      datasets: [{
        label: 'Saldo Acumulado',
        data: [],
        borderColor: '#007BFF',
        borderWidth: 2,
        fill: false
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });

  function atualizarGrafico(data) {
    grafico.data.datasets[0].data = data;
    grafico.update();
  }
</script>

</body>
</html>
