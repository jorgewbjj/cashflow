<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Fluxo de Caixa - 24 Meses</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* ... (seu CSS igual ao anterior) ... */
  </style>
</head>
<body>
  <div class="container">
    <h2>Fluxo de Caixa ‚Äî 24 Meses</h2>
    <div class="actions-bar">
      <button id="addCategoryBtn">+ Adicionar Categoria</button>
      <button id="showPastMonthsBtn">Mostrar meses anteriores</button>
    </div>
    <div class="table-container">
      <table id="cashFlowTable">
        <thead>
          <tr>
            <th>Categoria</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr id="monthlyTotalRow"><td>Saldo do M√™s</td></tr>
          <tr id="accumulatedTotalRow" class="tfoot-bold"><td>Saldo Acumulado</td></tr>
        </tfoot>
      </table>
    </div>
    <canvas id="chart" height="85"></canvas>
  </div>
  <div id="dropdown-holder"></div>
  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyC8w5g9ot_LWkFgpsZN0UBDOeREeSd17UA",
      authDomain: "cashflow-6188e.firebaseapp.com",
      databaseURL: "https://cashflow-6188e-default-rtdb.firebaseio.com",
      projectId: "cashflow-6188e",
      storageBucket: "cashflow-6188e.appspot.com",
      messagingSenderId: "644882577807",
      appId: "1:644882577807:web:92e5e6df27c4d0d7feb3fa"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Globais
    let visiveis = 24;
    let mesesAnterioresVisiveis = 0;
    let meses = [];
    let categorias = [];
    let valoresPorCategoria = {};

    function gerarMeses(qtd, mesesAnteriores) {
      const lista = [];
      const hoje = new Date();
      hoje.setDate(1);
      let inicio = new Date(hoje);
      inicio.setMonth(inicio.getMonth() - mesesAnteriores);
      for (let i = 0; i < qtd; i++) {
        let d = new Date(inicio.getFullYear(), inicio.getMonth() + i, 1);
        let mesAbrev = d.toLocaleString('pt-BR', { month: 'short' }).replace('.', '');
        let ano = d.getFullYear().toString().slice(2);
        lista.push(`${mesAbrev.charAt(0).toUpperCase() + mesAbrev.slice(1)}/${ano}`);
      }
      return lista;
    }
    function atualizarMeses() {
      meses = gerarMeses(visiveis + mesesAnterioresVisiveis, mesesAnterioresVisiveis);
    }
    atualizarMeses();

    function redesenharCabecalhos() {
      const theadRow = document.querySelector("thead tr");
      const totalRow = document.getElementById("monthlyTotalRow");
      const acumuladoRow = document.getElementById("accumulatedTotalRow");
      theadRow.innerHTML = "<th>Categoria</th>";
      totalRow.innerHTML = "<td>Saldo do M√™s</td>";
      acumuladoRow.innerHTML = "<td>Saldo Acumulado</td>";
      meses.forEach(m => {
        theadRow.innerHTML += `<th>${m}</th>`;
        totalRow.innerHTML += `<td>R$¬†0,00</td>`;
        acumuladoRow.innerHTML += `<td>R$¬†0,00</td>`;
      });
    }

    function normalizarValoresCategorias() {
      categorias.forEach(cat => {
        let arr = valoresPorCategoria[cat.nome] || [];
        if (arr.length < meses.length) arr = arr.concat(Array(meses.length - arr.length).fill(""));
        if (arr.length > meses.length) arr = arr.slice(arr.length - meses.length);
        valoresPorCategoria[cat.nome] = arr;
      });
    }

    function renderizarTabela() {
      atualizarMeses();
      redesenharCabecalhos();
      normalizarValoresCategorias();
      const tbody = document.querySelector("tbody");
      tbody.innerHTML = '';
      categorias.forEach((cat, idx) => {
        let valores = valoresPorCategoria[cat.nome] || [];
        const tr = document.createElement("tr");
        tr.dataset.nome = cat.nome;
        tr.dataset.tipo = cat.tipo;
        tr.dataset.idx = idx;
        const tdLabel = document.createElement("td");
        const labelSpan = document.createElement("span");
        labelSpan.textContent = cat.nome;
        labelSpan.className = "cat-label";
        labelSpan.tabIndex = 0;
        labelSpan.onclick = function(e) {
          e.stopPropagation();
          document.querySelectorAll('.cat-label').forEach(s=>s.classList.remove('active'));
          document.querySelectorAll('.cat-actions').forEach(a=>a.style.display='none');
          labelSpan.classList.add('active');
          actionsSpan.style.display = "inline-flex";
        };
        tdLabel.appendChild(labelSpan);
        const actionsSpan = document.createElement("span");
        actionsSpan.className = "cat-actions";
        actionsSpan.innerHTML = `
          <button class="cat-btn" title="Mover para cima" onclick="moveCategoria('${cat.nome}', -1)">‚Üë</button>
          <button class="cat-btn" title="Mover para baixo" onclick="moveCategoria('${cat.nome}', 1)">‚Üì</button>
          <button class="cat-btn" title="Editar" onclick="editarCategoria('${cat.nome}')">‚úèÔ∏è</button>
          <button class="cat-btn" title="Excluir" onclick="removerCategoria('${cat.nome}')">üóëÔ∏è</button>
        `;
        tdLabel.appendChild(actionsSpan);
        tr.appendChild(tdLabel);

        for (let i = 0; i < meses.length; i++) {
          const td = document.createElement("td");
          td.contentEditable = true;
          td.inputMode = "decimal";
          let valorAtual = valores[i] || "";
          td.textContent = valorAtual !== "" ? fmtBRL(parseFloat(valorAtual)) : "";
          td.addEventListener("focus", function() {
            let txt = td.textContent.replace(/[^\d,-]/g, '').replace(',', '.');
            td.textContent = (parseFloat(txt) || txt === "0" ? txt : "");
            setTimeout(() => {
              const range = document.createRange();
              range.selectNodeContents(td);
              const sel = window.getSelection();
              sel.removeAllRanges();
              sel.addRange(range);
            }, 0);
          });
          td.addEventListener("blur", function() {
            let txt = td.textContent.replace(/[^\d,-]/g, '').replace(',', '.');
            let vNum = parseFloat(txt);
            td.textContent = (txt.trim() === "" || isNaN(vNum)) ? "" : fmtBRL(vNum);
            valoresPorCategoria[cat.nome][i] = (txt.trim() === "" || isNaN(vNum)) ? "" : vNum;
            salvarCategorias();
            calcularTotais();
          });
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      });
      calcularTotais();
    }

    function calcularTotais() {
      const totalRow = document.getElementById("monthlyTotalRow");
      const acumuladoRow = document.getElementById("accumulatedTotalRow");
      const totais = Array(meses.length).fill(0);
      const acumulados = Array(meses.length).fill(0);
      document.querySelectorAll("tbody tr").forEach(tr => {
        const tipo = tr.dataset.tipo;
        [...tr.cells].slice(1).forEach((td, idx) => {
          let txt = td.textContent.replace(/[^\d,-]/g, '').replace(',', '.');
          let val = parseFloat(txt) || 0;
          if (tipo === "despesa") val *= -1;
          totais[idx] += val;
        });
      });
      totais.forEach((v, i) => {
        totalRow.cells[i + 1].textContent = fmtBRL(v);
        acumulados[i] = (acumulados[i - 1] || 0) + v;
        acumuladoRow.cells[i + 1].textContent = fmtBRL(acumulados[i]);
      });
      atualizarGrafico(acumulados);
    }

    function fmtBRL(v) {
      return "R$¬†" + (isNaN(v) ? "0,00" : v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));
    }

    function salvarCategorias() {
      normalizarValoresCategorias();
      db.ref("categorias").set(categorias, function() {
        db.ref("valores").set(valoresPorCategoria);
      });
    }

    // --- MODAL ADD CATEGORIA ---
    document.getElementById("addCategoryBtn").onclick = () => {
      atualizarMeses();
      let dropdownHolder = document.getElementById('dropdown-holder');
      const modal = document.createElement('div');
      modal.className = "dropdown-modal";
      modal.innerHTML = `
        <h3>Adicionar categoria</h3>
        <input id="cat-nome-input" type="text" placeholder="Nome da categoria" maxlength="28" />
        <select id="cat-tipo-select">
          <option value="receita">Receita</option>
          <option value="despesa">Despesa</option>
        </select>
        <button id="cat-add-confirm">Adicionar</button>
      `;
      const backdrop = document.createElement('div');
      backdrop.className = "dropdown-backdrop";
      backdrop.onclick = fecharDropdown;

      function fecharDropdown() { dropdownHolder.innerHTML = ''; }
      dropdownHolder.innerHTML = '';
      dropdownHolder.appendChild(backdrop);
      dropdownHolder.appendChild(modal);

      document.getElementById("cat-add-confirm").onclick = function() {
        const nome = document.getElementById("cat-nome-input").value.trim();
        const tipo = document.getElementById("cat-tipo-select").value;
        if (!nome) { alert("Digite um nome."); return; }
        if (!["receita", "despesa"].includes(tipo)) { alert("Tipo inv√°lido."); return; }
        if (categorias.find(c=>c.nome === nome)) { alert("Categoria j√° existe."); return; }
        categorias.push({ nome, tipo });
        valoresPorCategoria[nome] = Array(meses.length).fill("");
        salvarCategorias();
        fecharDropdown();
      };
      document.getElementById("cat-nome-input").focus();
    };

    // --- MODAL EDITAR CATEGORIA ---
    window.editarCategoria = function(nome) {
      atualizarMeses();
      let dropdownHolder = document.getElementById('dropdown-holder');
      const cat = categorias.find(c => c.nome === nome);
      if (!cat) return;
      const modal = document.createElement('div');
      modal.className = "dropdown-modal";
      modal.innerHTML = `
        <h3>Editar categoria</h3>
        <input id="cat-nome-edit" type="text" value="${cat.nome}" maxlength="28" />
        <select id="cat-tipo-edit">
          <option value="receita"${cat.tipo==='receita'?' selected':''}>Receita</option>
          <option value="despesa"${cat.tipo==='despesa'?' selected':''}>Despesa</option>
        </select>
        <button id="cat-edit-confirm">Salvar</button>
      `;
      const backdrop = document.createElement('div');
      backdrop.className = "dropdown-backdrop";
      backdrop.onclick = fecharDropdown;
      function fecharDropdown() { dropdownHolder.innerHTML = ''; }
      dropdownHolder.innerHTML = '';
      dropdownHolder.appendChild(backdrop);
      dropdownHolder.appendChild(modal);

      document.getElementById("cat-edit-confirm").onclick = function() {
        const novonome = document.getElementById("cat-nome-edit").value.trim();
        const tipo = document.getElementById("cat-tipo-edit").value;
        if (!novonome) { alert("Digite um nome."); return; }
        if (!["receita", "despesa"].includes(tipo)) { alert("Tipo inv√°lido."); return; }
        if (novonome !== cat.nome && categorias.find(c=>c.nome === novonome)) { alert("Categoria j√° existe."); return; }
        valoresPorCategoria[novonome] = valoresPorCategoria[cat.nome] || Array(meses.length).fill("");
        if (novonome !== cat.nome) delete valoresPorCategoria[cat.nome];
        cat.nome = novonome;
        cat.tipo = tipo;
        salvarCategorias();
        fecharDropdown();
      };
      document.getElementById("cat-nome-edit").focus();
    };

    window.removerCategoria = function(nome) {
      if (!confirm("Remover categoria?")) return;
      categorias = categorias.filter(c => c.nome !== nome);
      delete valoresPorCategoria[nome];
      salvarCategorias();
    };

    window.moveCategoria = function(nome, dir) {
      const idx = categorias.findIndex(c => c.nome === nome);
      if (idx < 0) return;
      let novoIdx = idx + dir;
      if (novoIdx < 0 || novoIdx >= categorias.length) return;
      [categorias[idx], categorias[novoIdx]] = [categorias[novoIdx], categorias[idx]];
      salvarCategorias();
    };

    function carregarTudo() {
      db.ref("categorias").once("value", snap => {
        categorias = snap.val() || [];
        db.ref("valores").once("value", valSnap => {
          valoresPorCategoria = valSnap.val() || {};
          renderizarTabela();
          calcularTotais();
        });
      });
    }

    // Chart.js gr√°fico
    const ctx = document.getElementById('chart').getContext('2d');
    const grafico = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Saldo Acumulado',
          data: [],
          borderColor: '#007BFF',
          borderWidth: 2,
          fill: true,
          backgroundColor: 'rgba(0,123,255,0.09)',
          pointRadius: 2
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { display: true },
          y: {
            beginAtZero: false,
            ticks: {
              callback: value => 'R$¬†' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2})
            }
          }
        }
      }
    });

    function atualizarGrafico(data) {
      grafico.data.labels = meses;
      grafico.data.datasets[0].data = data;
      grafico.update();
    }

    carregarTudo();

    window.addEventListener('resize', () => grafico.resize());

    db.ref("categorias").on("value", snap => {
      categorias = snap.val() || [];
      db.ref("valores").once("value", valSnap => {
        valoresPorCategoria = valSnap.val() || {};
        renderizarTabela();
        calcularTotais();
      });
    });
    db.ref("valores").on("value", valSnap => {
      valoresPorCategoria = valSnap.val() || {};
      renderizarTabela();
      calcularTotais();
    });

    document.body.addEventListener('click', function(e){
      document.querySelectorAll('.cat-label').forEach(s=>s.classList.remove('active'));
      document.querySelectorAll('.cat-actions').forEach(a=>a.style.display='none');
    });

    document.getElementById('showPastMonthsBtn').onclick = function() {
      mesesAnterioresVisiveis += 3;
      renderizarTabela();
      calcularTotais();
    };
  </script>
</body>
</html>
