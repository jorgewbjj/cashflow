<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Fluxo de Caixa - 24 Meses</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-database-compat.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      background: #f5f6fa;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    .container {
      max-width: 98vw;
      margin: 24px auto;
      padding: 8px;
    }
    h2 {
      font-weight: 700;
      font-size: 1.35rem;
      margin-bottom: 16px;
      color: #222;
      letter-spacing: -1px;
      text-align: center;
    }
    .actions-bar {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      align-items: center;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }
    #addCategoryBtn {
      background: #fff;
      border: 1px solid #007BFF;
      color: #007BFF;
      padding: 6px 14px;
      border-radius: 8px;
      font-size: 0.98rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.1s, color 0.1s;
      box-shadow: 0 1px 4px #0001;
    }
    #addCategoryBtn:hover {
      background: #007BFF;
      color: #fff;
    }
    .table-container {
      width: 100%;
      overflow-x: auto;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 3px 14px #0001;
      padding: 8px 0 8px 0;
    }
    table {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      min-width: 680px;
      font-size: 0.98rem;
      background: #fff;
    }
    thead tr {
      background: #007BFF;
      color: #fff;
    }
    th, td {
      padding: 5px 8px;
      border-bottom: 1px solid #e3e7ee;
      min-width: 74px;
      text-align: right;
      white-space: nowrap;
    }
    th:first-child, td:first-child {
      position: sticky;
      left: 0;
      background: #f7faff;
      text-align: left;
      z-index: 2;
      min-width: 136px;
      font-weight: 600;
      box-shadow: 3px 0 8px -7px #3333;
    }
    td[contenteditable="true"] {
      background: #f6faff;
      border-radius: 7px;
      outline: none;
      cursor: pointer;
      transition: background 0.12s;
    }
    td[contenteditable="true"]:focus {
      background: #e6f0ff;
      box-shadow: 0 0 0 2px #007bff33;
    }
    tfoot tr {
      background: #f0f6ff;
      font-weight: 600;
    }
    .cat-actions {
      display: flex;
      align-items: center;
      gap: 3px;
      margin-left: 4px;
    }
    .cat-btn {
      background: none;
      border: none;
      color: #999;
      font-size: 1em;
      cursor: pointer;
      padding: 1px 4px;
      border-radius: 3px;
      transition: color 0.15s, background 0.1s;
    }
    .cat-btn:hover {
      color: #007bff;
      background: #e7f0ff;
    }
    @media (max-width: 760px) {
      .container {
        max-width: 99vw;
        margin: 0;
        padding: 2px;
      }
      h2 { font-size: 1rem; }
      th, td {
        min-width: 56px;
        font-size: 0.93rem;
        padding: 4px 4px;
      }
      th:first-child, td:first-child {
        min-width: 95px;
      }
      .table-container {
        padding: 0;
      }
    }
    #chart {
      margin-top: 16px;
      max-width: 99vw;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 2px 14px #0001;
      padding: 10px 0;
      min-height: 120px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Fluxo de Caixa ‚Äî 24 Meses</h2>
    <div class="actions-bar">
      <button id="addCategoryBtn">+ Adicionar Categoria</button>
    </div>
    <div class="table-container">
      <table id="cashFlowTable">
        <thead>
          <tr>
            <th>Categoria</th>
            <!-- Meses via JS -->
          </tr>
        </thead>
        <tbody>
          <!-- Linhas via JS -->
        </tbody>
        <tfoot>
          <tr id="monthlyTotalRow"><td>Saldo do M√™s</td></tr>
          <tr id="accumulatedTotalRow"><td>Saldo Acumulado</td></tr>
        </tfoot>
      </table>
    </div>
    <canvas id="chart" height="85"></canvas>
  </div>
  <script>
    // Substitua abaixo com seu firebaseConfig!
  const firebaseConfig = {
  apiKey: "AIzaSyC8w5g9ot_LWkFgpsZN0UBDOeREeSd17UA",
  authDomain: "cashflow-6188e.firebaseapp.com",
  databaseURL: "https://cashflow-6188e-default-rtdb.firebaseio.com",
  projectId: "cashflow-6188e",
  storageBucket: "cashflow-6188e.firebasestorage.app",
  messagingSenderId: "644882577807",
  appId: "1:644882577807:web:92e5e6df27c4d0d7feb3fa"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Datas
    const meses = Array.from({ length: 24 }, (_, i) => {
      const d = new Date();
      d.setMonth(d.getMonth() + i);
      return d.toLocaleString('pt-BR', { month: 'short', year: '2-digit' });
    });

    const table = document.getElementById("cashFlowTable");
    const theadRow = table.querySelector("thead tr");
    const tbody = table.querySelector("tbody");
    const totalRow = document.getElementById("monthlyTotalRow");
    const acumuladoRow = document.getElementById("accumulatedTotalRow");

    // Monta cabe√ßalhos
    meses.forEach(m => {
      theadRow.innerHTML += `<th>${m}</th>`;
      totalRow.innerHTML += `<td>R$¬†0,00</td>`;
      acumuladoRow.innerHTML += `<td>R$¬†0,00</td>`;
    });

    // --- Firebase data models
    let categorias = [];
    let valoresPorCategoria = {}; // { nomeCategoria: [valores...] }

    // Utilit√°rio formatador de moeda BRL
    function fmtBRL(v) {
      return "R$¬†" + (isNaN(v) ? "0,00" : v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));
    }

    // Cria linha de categoria
    function desenharLinhaCategoria(cat, idx, valores = []) {
      const tr = document.createElement("tr");
      tr.dataset.nome = cat.nome;
      tr.dataset.tipo = cat.tipo;
      tr.dataset.idx = idx;

      // Coluna label + bot√µes
      const tdLabel = document.createElement("td");
      tdLabel.innerHTML = `<span>${cat.nome}</span>
        <span class="cat-actions">
          <button class="cat-btn" title="Mover para cima" onclick="moveCategoria('${cat.nome}', -1)">‚Üë</button>
          <button class="cat-btn" title="Mover para baixo" onclick="moveCategoria('${cat.nome}', 1)">‚Üì</button>
          <button class="cat-btn" title="Editar" onclick="editarCategoria('${cat.nome}')">‚úèÔ∏è</button>
          <button class="cat-btn" title="Excluir" onclick="removerCategoria('${cat.nome}')">üóëÔ∏è</button>
        </span>`;
      tr.appendChild(tdLabel);

      for (let i = 0; i < 24; i++) {
        const td = document.createElement("td");
        td.contentEditable = true;
        td.inputMode = "decimal";
        let valor = valores[i] || "";
        td.textContent = valor ? fmtBRL(parseFloat(valor)) : "";
        td.addEventListener("focus", function() {
          // ao focar, mostra o valor num√©rico puro para facilitar digita√ß√£o
          td.textContent = valor || "";
        });
        td.addEventListener("blur", function() {
          valor = td.textContent.replace(/\D/g,'');
          valor = td.textContent.replace(/[^\d,-]/g, '').replace(',', '.');
          let vNum = parseFloat(valor) || 0;
          td.textContent = td.textContent.trim() ? fmtBRL(vNum) : "";
          atualizarEAtualizarDB();
        });
        td.addEventListener("input", () => {
          atualizarEAtualizarDB();
        });
        tr.appendChild(td);
      }
      return tr;
    }

    // Desenha tabela inteira
    function renderizarTabela() {
      tbody.innerHTML = '';
      categorias.forEach((cat, idx) => {
        const valores = valoresPorCategoria[cat.nome] || Array(24).fill("");
        tbody.appendChild(desenharLinhaCategoria(cat, idx, valores));
      });
      calcularTotais();
    }

    // Calcula totais
    function calcularTotais() {
      const totais = Array(24).fill(0);
      const acumulados = Array(24).fill(0);
      tbody.querySelectorAll("tr").forEach(tr => {
        const tipo = tr.dataset.tipo;
        [...tr.cells].slice(1).forEach((td, idx) => {
          let txt = td.textContent.replace(/[^\d,-]/g, '').replace(',', '.');
          let val = parseFloat(txt) || 0;
          if (tipo === "despesa") val *= -1;
          totais[idx] += val;
        });
      });
      totais.forEach((v, i) => {
        totalRow.cells[i + 1].textContent = fmtBRL(v);
        acumulados[i] = (acumulados[i - 1] || 0) + v;
        acumuladoRow.cells[i + 1].textContent = fmtBRL(acumulados[i]);
      });
      atualizarGrafico(acumulados);
    }

    // Atualiza e salva valores no DB
    function atualizarEAtualizarDB() {
      valoresPorCategoria = {};
      tbody.querySelectorAll("tr").forEach(tr => {
        const nome = tr.dataset.nome;
        const valores = [...tr.cells].slice(1).map(td => {
          let txt = td.textContent.replace(/[^\d,-]/g, '').replace(',', '.');
          let val = parseFloat(txt) || "";
          return val === "" ? "" : val;
        });
        valoresPorCategoria[nome] = valores;
      });
      db.ref("valores").set(valoresPorCategoria);
      calcularTotais();
    }

    // Adicionar nova categoria
    document.getElementById("addCategoryBtn").onclick = () => {
      const nome = prompt("Nome da categoria:");
      if (!nome) return;
      let tipo = prompt("Tipo: receita ou despesa?").trim().toLowerCase();
      if (!["receita", "despesa"].includes(tipo)) return alert("Digite receita ou despesa.");
      categorias.push({ nome, tipo });
      valoresPorCategoria[nome] = Array(24).fill("");
      salvarCategorias();
      renderizarTabela();
    };

    // Editar categoria
    window.editarCategoria = function(nome) {
      const cat = categorias.find(c => c.nome === nome);
      if (!cat) return;
      let novonome = prompt("Novo nome da categoria:", cat.nome);
      if (!novonome || novonome.trim() === "" || novonome === cat.nome) return;
      let tipo = prompt("Tipo: receita ou despesa?", cat.tipo).trim().toLowerCase();
      if (!["receita", "despesa"].includes(tipo)) return alert("Digite receita ou despesa.");
      // Atualiza categoria e valores
      valoresPorCategoria[novonome] = valoresPorCategoria[nome] || Array(24).fill("");
      delete valoresPorCategoria[nome];
      cat.nome = novonome;
      cat.tipo = tipo;
      salvarCategorias();
      renderizarTabela();
    };

    // Excluir categoria
    window.removerCategoria = function(nome) {
      if (!confirm("Remover categoria?")) return;
      categorias = categorias.filter(c => c.nome !== nome);
      delete valoresPorCategoria[nome];
      salvarCategorias();
      renderizarTabela();
    };

    // Reorganizar categorias
    window.moveCategoria = function(nome, dir) {
      const idx = categorias.findIndex(c => c.nome === nome);
      if (idx < 0) return;
      let novoIdx = idx + dir;
      if (novoIdx < 0 || novoIdx >= categorias.length) return;
      [categorias[idx], categorias[novoIdx]] = [categorias[novoIdx], categorias[idx]];
      salvarCategorias();
      renderizarTabela();
    };

    // Salva categorias e ordem
    function salvarCategorias() {
      db.ref("categorias").set(categorias);
      db.ref("valores").set(valoresPorCategoria);
    }

    // Carrega do Firebase
    function carregarTudo() {
      db.ref("categorias").once("value", snap => {
        categorias = snap.val() || [];
        db.ref("valores").once("value", valSnap => {
          valoresPorCategoria = valSnap.val() || {};
          renderizarTabela();
        });
      });
    }

    // Chart.js gr√°fico
    const ctx = document.getElementById('chart').getContext('2d');
    const grafico = new Chart(ctx, {
      type: 'line',
      data: {
        labels: meses,
        datasets: [{
          label: 'Saldo Acumulado',
          data: [],
          borderColor: '#007BFF',
          borderWidth: 2,
          fill: true,
          backgroundColor: 'rgba(0,123,255,0.09)',
          pointRadius: 2
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: { display: true },
          y: {
            beginAtZero: false,
            ticks: {
              callback: value => 'R$¬†' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2})
            }
          }
        }
      }
    });

    function atualizarGrafico(data) {
      grafico.data.datasets[0].data = data;
      grafico.update();
    }

    // Inicializa ao abrir
    carregarTudo();

    // Responsividade extra
    window.addEventListener('resize', () => grafico.resize());

    // Hot reload de dados do Firebase (opcional: remova se n√£o quiser realtime ao editar de outro lugar)
    db.ref("categorias").on("value", snap => {
      categorias = snap.val() || [];
      db.ref("valores").once("value", valSnap => {
        valoresPorCategoria = valSnap.val() || {};
        renderizarTabela();
      });
    });
    db.ref("valores").on("value", valSnap => {
      valoresPorCategoria = valSnap.val() || {};
      renderizarTabela();
    });
  </script>
</body>
</html>
